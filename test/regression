#!/usr/bin/env python3

import shutil
import os
import subprocess
import glob

EXE_PATH = "../build/pruneccs"
RESULTS_DIR = "./results"
DIFFS_FILE = os.path.join(RESULTS_DIR, "diffs")

os.makedirs(RESULTS_DIR, exist_ok=True)

open(DIFFS_FILE, 'w').close()

def run_test(exe_path, input_file):
    base_name = os.path.basename(input_file)
    golden_file = input_file + ".ok"
    log_file = os.path.join(RESULTS_DIR, base_name + ".log")
    
    try:
        with open(log_file, "w") as outfile:
            subprocess.run(
                [exe_path, input_file],
                stdout=outfile,
                stderr=subprocess.STDOUT, 
                text=True
            )
    except FileNotFoundError:
        print(f"CRITICAL: Executable not found at {exe_path}")
        return

    if not os.path.exists(golden_file):
        print(f"SKIP: {input_file} (No .ok file found)")
        return

    diff_proc = subprocess.run(
        ["diff", "-c", golden_file, log_file],
        capture_output=True,
        text=True
    )
    
    diff_output = diff_proc.stdout

    if not diff_output or diff_output.strip() == "":
        print(f"PASS: {base_name}")
    else:
        print(f"FAIL: {base_name}")
        with open(DIFFS_FILE, "a") as f:
            f.write(diff_output)


print(f"Running tests from {os.getcwd()}...\n")

lib_files = glob.glob("*.lib")

copy_out_out = "idempotency.lib"

if not lib_files:
    print("No .lib files found.")
else:
    for lib in lib_files:
        if (lib == copy_out_out):
            continue
        run_test(EXE_PATH, lib)

shutil.copy(os.path.join(RESULTS_DIR, lib_files[0] + ".log"), copy_out_out)
shutil.copy(os.path.join(RESULTS_DIR, lib_files[0] + ".log"), copy_out_out+".ok")
run_test(EXE_PATH, copy_out_out);

if os.path.getsize(DIFFS_FILE) > 0:
    print(f"\nThere were failures. See details in: {DIFFS_FILE}")
    exit(1)
else:
    print("\nAll tests passed.")
    exit(0)
