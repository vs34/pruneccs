#!/usr/bin/env python3
"""
Regression test for pruneccs.

Usage:
    ./regression
"""

# Python imports
import glob
import os
import shutil
import subprocess
import sys

# Paths
EXE_PATH = "../build/pruneccs"
RESULTS_DIR = "./results"
DIFFS_FILE = os.path.join(RESULTS_DIR, "diffs")

def run_test(exe_path, input_file):
    """
    Run a test and compare the output to the golden file.

    Args:
        exe_path: The path to the executable to run.
        input_file: The path to the input file to run.

    Returns:
        None
    """
    # Get names
    base_name = os.path.basename(input_file)
    golden_file = input_file + ".ok"
    log_file = os.path.join(RESULTS_DIR, base_name + ".log")

    # Run the test
    try:
        with open(log_file, "w", encoding="utf-8") as outfile:
            subprocess.run(
                [exe_path, input_file],
                stdout=outfile,
                stderr=subprocess.STDOUT,
                text=True,
                check=False
            )
    except FileNotFoundError:
        print(f"CRITICAL: Executable not found at {exe_path}")
        return

    # Check if the golden file exists
    if not os.path.exists(golden_file):
        print(f"SKIP: {input_file} (No .ok file found)")
        return

    # Compare the output to the golden file
    diff_proc = subprocess.run(
        ["diff", "-c", golden_file, log_file],
        capture_output=True,
        text=True,
        check=False
    )

    # Get the diff output
    diff_output = diff_proc.stdout

    # Check if the diff output is empty and print the result
    if not diff_output or diff_output.strip() == "":
        print(f"PASS: {base_name}")
    else:
        print(f"FAIL: {base_name}")
        with open(DIFFS_FILE, "a", encoding="utf-8") as f:
            f.write(diff_output)

if __name__ == "__main__":
    # Create the results directory
    os.makedirs(RESULTS_DIR, exist_ok=True)

    # Create the diffs file
    with open(DIFFS_FILE, "w", encoding="utf-8") as _:
        pass

    # Print the running test directory
    print(f"Running tests from {os.getcwd()}...\n")

    # Get the library files
    lib_files = glob.glob("*.lib")

    # Check if there are any library files
    if not lib_files:
        print("No .lib files found.")
    else:
        for lib in lib_files:
            run_test(EXE_PATH, lib)

    # Check if there were any failures
    if os.path.getsize(DIFFS_FILE) > 0:
        print(f"\nThere were failures. See details in: {DIFFS_FILE}")
        sys.exit(1)
    else:
        print("\nAll tests passed.")
        sys.exit(0)
